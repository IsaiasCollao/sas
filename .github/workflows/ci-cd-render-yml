name: CI / Tests / Deploy (Render)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  # Ajusta estas rutas si tu repo usa carpetas diferentes
  BACKEND_PATH: "Tienda-Gamer-feature-maxi"    # <- cambia si tu backend está en otra carpeta
  FRONTEND_PATH: "Tienda-Gamer-maxi-front"    # <- cambia si tu frontend está en otra carpeta

jobs:
  backend:
    name: Build & Test - Backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.BACKEND_PATH }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      - name: Build & run tests (Maven)
        run: mvn -B clean test

  frontend:
    name: Build - Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.FRONTEND_PATH }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm ci

      - name: Build production
        run: |
          npm run build

  deploy-to-render:
    name: Deploy to Render (API)
    runs-on: ubuntu-latest
    needs: [ backend, frontend ]
    environment: production

    steps:
      - name: Install jq (para parsear JSON)
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Trigger backend deploy (Render API)
        id: deploy-backend
        run: |
          set -e
          echo "Triggering deploy for backend service ${{ secrets.RENDER_BACKEND_SERVICE_ID }} ..."
          resp=$(curl -s -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_BACKEND_SERVICE_ID }}/deploys" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{}')
          echo "response: $resp"
          deploy_id=$(echo "$resp" | jq -r '.id')
          if [ "$deploy_id" = "null" ] || [ -z "$deploy_id" ]; then
            echo "Failed to create backend deploy. Response:"
            echo "$resp"
            exit 1
          fi
          echo "backend_deploy_id=$deploy_id" >> $GITHUB_OUTPUT

      - name: Wait backend deploy finish (poll)
        run: |
          set -e
          deploy_id="${{ steps.deploy-backend.outputs.backend_deploy_id }}"
          echo "Polling backend deploy status: $deploy_id"
          for i in $(seq 1 30); do
            status=$(curl -s -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
              "https://api.render.com/v1/services/${{ secrets.RENDER_BACKEND_SERVICE_ID }}/deploys/$deploy_id" | jq -r '.status')
            echo "Attempt $i - status=$status"
            if [[ "$status" == "success" ]]; then
              echo "Backend deploy success"
              break
            elif [[ "$status" == "failed" ]]; then
              echo "Backend deploy failed"
              exit 1
            fi
            sleep 10
          done

      - name: Trigger frontend deploy (Render API)
        id: deploy-frontend
        run: |
          set -e
          echo "Triggering deploy for frontend service ${{ secrets.RENDER_FRONTEND_SERVICE_ID }} ..."
          resp=$(curl -s -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_FRONTEND_SERVICE_ID }}/deploys" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{}')
          echo "response: $resp"
          deploy_id=$(echo "$resp" | jq -r '.id')
          if [ "$deploy_id" = "null" ] || [ -z "$deploy_id" ]; then
            echo "Failed to create frontend deploy. Response:"
            echo "$resp"
            exit 1
          fi
          echo "frontend_deploy_id=$deploy_id" >> $GITHUB_OUTPUT

      - name: Wait frontend deploy finish (poll)
        run: |
          set -e
          deploy_id="${{ steps.deploy-frontend.outputs.frontend_deploy_id }}"
          echo "Polling frontend deploy status: $deploy_id"
          for i in $(seq 1 30); do
            status=$(curl -s -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
              "https://api.render.com/v1/services/${{ secrets.RENDER_FRONTEND_SERVICE_ID }}/deploys/$deploy_id" | jq -r '.status')
            echo "Attempt $i - status=$status"
            if [[ "$status" == "success" ]]; then
              echo "Frontend deploy success"
              break
            elif [[ "$status" == "failed" ]]; then
              echo "Frontend deploy failed"
              exit 1
            fi
            sleep 10
          done
